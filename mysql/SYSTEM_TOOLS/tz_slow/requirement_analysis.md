# 天照系统之需求分析
> 为什么取名为天照，源自火影中血轮眼发动的特殊技能 天照，月读。 天照：源自太阳中心的火焰,是一种很强的火遁，使用写轮眼直视目标，使目标被黑色火焰吞噬，黑色火焰将目之所及的一切燃烧殆尽，此火焰会一直燃烧下去，直至目标销毁。这里和我们的目标一样，消除线上所有会引发故障的隐患，两个目标：准确定位问题 && 从根本上解决问题。

## 我们的初衷
---

* 发现线上的slow，将影响严重的sql抓取出来，让对应的人员方便快速的解决并优化。
* 发现重大slow，严重影响性能或者故障的SQL，应该提供出相应的状态信息，并且帮助立刻解决。
* 不仅仅是slow，我们还关注分析线上的运行状况，提前找出隐患所在。

##  需求分析
----

* 分类：

```

1)我们将线上的故障点按照触发的时间点分类： 事前，事中，事后。
2)我们按照用户分类： DBA ， PD。
	DBA： 更多关注的是 DB group 的状态。
	PD：  更多关注的是自己业务的状态。
```

**下面具体谈谈各自的需求。**

* 事前

```
1）通过PG && 测试环境的 SQL 抓取，分析SQL
2）使用中间件，将上线前的SQL 语句抓取，分析SQL
3）DBRT，再开发提交需求前，分析SQL

```
以上的需求，我们会通过DBRT自动审核系统和中间件完成，不是此系统的关注点。

* 事中

```
1）抓取线上sleep 状态中的 thread id，分析为什么会sleep 那么久?
2）抓取线上thread running状态中的 SQL， 分析为什么会 exec 那么长时间？
3）抓取线上的来源ip，统计分析ip之间是否有何规律，能否发现异常？
```

* 事后

```
<PD>
1）开发只需要属于他们自己业务相关的slow，提供订阅关注功能。
2）开发只需要他们能解决的slow，  比如：insert，delete就不怎么关心，主要关心select
3）开发需要 挑选出 比较重要且紧急的slow	 比如：Top N 查询时间最长 or 出现次数最多的topN。
	 第一层：开发订阅业务中哪个需要重点优化。  
	 第二层：开发订阅的业务机器中，每一台机器中，哪个最需要优化。 

4）开发需要一些SQL的分析信息，以便于解决slow。
	查询计划，实际物理读写，还要给出这台实例的cpu负载，util负载，IOPS，链接数 等等
5）开发需要分发指派功能，以便每类SQL有负责人，这样更加精细化。 包括：此SQL 处理人，处理过程，处理状态 等。(注意：最好能够和ibug结合起来，因为开发天天关注ibug)
6）开发需要验证 此类SQL 的优化效果。  数字和图，更加直观展示（暂定每小时计算）。
7）可以提供简单的优化方案或者建议
8）总体的报表，按照业务区分。

<DBA>
1）总体的报表，按照DB Group区分。
2）SQL 种类划分，IDUS。
3）TopN，即各种排序功能。
4）SQL的分析信息，用于故障诊断
	查询计划，实际物理读写，还要给出这台实例的cpu负载，util负载，IOPS，链接数 等等
5）可以提供简单的优化方案或者建议
6）每一种SQL，提供数字和图，更加直观展示，就是SQL的history（暂定每小时计算）。

<综合>
1）业务app ip ， 提供一个界面，让开发自己提交 【ip集合,业务名】， 然后让对应的leader或其他人关注业务，这样对应的app ip 就会随之一起关注。
2） 邮件，报警功能

```



